# Memory Management

## Presto 클러스터의 메모리 구성 및 관리 수행
- 지속적으로 변화하는 많은 요인들이 메모리 요구에 영향을 미침
  - 작업자수
  - 코디네이터와 작업자의 기억
  - 데이터 소스 수 및 유형
  - 실행 중인 쿼리의 특성
  - 사용자 수
- 작업자 클러스터를 사용하는 다중 사용자 시스템인 presto의 경우 자원 관리는 어려움
- 출발점을 선택하고 시스템을 모니터링하면서 현재 및 향후 요구 사항에 맞게 조정해야 함
  - 모든 메모리 관리는 실행중인 JVM에 적용됨
  - 값은 작업자의 JVM 내 할당이며, JVM 구성에서는 할당을 허용하려면 이러한 값의 크기를 고려해야 함
  - 동시 쿼리 수에 따라 JVM을 훨씬 더 큰 값으로 조정
- 위의 모든 요소들은 워크로드라고 부르는 것으로 결합됨
- 클러스터 메모리 조정은 실행 중인 워크로드에 크게 의존함
  - 예를 들어, 대부분의 쿼리 모양에는 다중 조인, 집계 및 윈도우 함수 기능이 ㅣ포함됨
- 워크로드의 쿼리 크기가 작을 경우 쿼리당 메모리 제한을 낮게 설정하고 동시성을 높일 수 있으며, 반대로 더 큰 쿼리 크기를 사용할 수도 있습니다.
- 쉽게 말해 쿼리 크기는 쿼리 모양과 입력 데이터 양의 곱이라고 생각하면 됨
- presto는 배포 시 `config.properties:`에 특정 속성을 설정하여 클러스터 전체의 메모리 사용률을 관리하는 방법을 제공함

  - `query.max-memory-per-node`
    - 쿼리가 집계 처리, 입력 데이터 할당 등을 위해 특정 작업자에서 사용할 수 있는 최대 사용자 메모리   
  - `query.max-total-memory-per-node`
    - 허용된 최대 사용자 및 시스템 메모리 합계이며, `query.max-total-memory-per-node`보다 커야 함
    - 사용자 및 시스템 할당에서 쿼리가 사용하는 메모리가 이 제한을 초과하면 삭제됨
  - `query.max-memory`
    - 쿼리가 클러스터의 모든 작업자에서 사용할 수 있는 최대 사용자 메모리
  - `query.max-total-memory`
    - 전체 클러스터에 대한 사용자 및 시스템 할당에 대한 쿼리에 의한 최대 메모리 사용률로, 결과적으로 `query.max-memory`보다 커야 함 
   
- Presto 메모리 관리는 두 가지 종류의 메모리 할당으로 구분
  - `User memory`(사용자 메모리)
    - 집계 및 정렬과 같은 사용자 쿼리는 사용자 메모리 할당을 제어
  - `System memory`(시스템 메모리)
    - 시스템 메모리 할당은 쿼리 엔진 자체의 실행 구현을 기반으로 하며 버퍼, 테이블 검색 및 기타 작업에 대한 읽기, 쓰기 및 셔플을 포함
     
---

## Reference
- Presto The Definitive Guide(O'REILLY)
